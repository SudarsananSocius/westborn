<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <template
        id="product_price_inherit_view"
        inherit_id="website_sale.product_price">
        
        <xpath expr="//div[@name='product_price_container']" position="after">
            <t t-if="product.credit_value">
                <div class="oe_product_credit_value">
                    <span t-field="product.credit_value" />
                    <span>Credits</span>
                </div>
            </t>
        </xpath>
        <xpath expr="//div[@name='product_price_container']" position="attributes">
            <attribute name="class">d-none</attribute>
        </xpath>
    </template>

    <template id="cart_lines_price_inherit" inherit_id="website_sale.cart_lines_price">
        
        <xpath expr="//h6[@name='website_sale_cart_line_price']" position="after">
            <t t-if="line.credit_points">
                <h6 class="d-flex flex-column flex-md-row align-items-end align-items-md-start justify-content-md-end mb-1">
                    <div class="oe_product_credit_value">
                        <span t-field="line.credit_points" />
                        <span>Credits</span>
                    </div>
                </h6>
            </t>
        </xpath>
        <xpath expr="//h6[@name='website_sale_cart_line_price']" position="attributes">
            <attribute name="class">d-none</attribute>
        </xpath>
    </template>

    <template id="credit_points_inherit" inherit_id="website_sale.total">
        <xpath expr="//tr[@name='o_order_total_untaxed']" position="after">
            <tr name="o_order_total_credits">
                    <td
                        class="border-0 pb-2 ps-0 pt-0 text-start text-muted"
                        colspan="2">
                        Total Credits
                    </td>
                    <td class="text-end border-0 pb-2 pe-0 pt-0">
                        <span t-out="website_sale_order._get_total_credits()"
                              style="white-space: nowrap;" />
                    </td>
                </tr>
        </xpath>
        <xpath expr="//tr[@name='o_order_total_untaxed']" position="attributes">
            <attribute name="class">d-none</attribute>          
        </xpath>
        <xpath expr="//tr[@name='o_order_total']" position="after">
            <tr name="o_order_total_credits" class="border-top">
                <td colspan="2" class="border-0 ps-0 pt-2"><strong>Total Credits To Pay</strong></td>
                <td class="text-end border-0 px-0 pt-2">
                    <strong t-field="website_sale_order.total_credits"
                            class="text-end p-0"
                            />
                </td>
            </tr>
        </xpath>
        <xpath expr="//tr[@name='o_order_total_taxes']" position="attributes">
            <attribute name="class">d-none</attribute>
        </xpath>
        <xpath expr="//tr[@name='o_order_total']" position="attributes">
            <attribute name="class">d-none</attribute>
        </xpath>
        <xpath expr="//tr[@name='o_order_delivery']" position="attributes">
            <attribute name="class">d-none</attribute>
        </xpath>
    </template>
    <template id="cart_summary_content_inherit" inherit_id="website_sale.cart_summary_content">
        <xpath expr="//td[@name='website_sale_cart_summary_line_price']//t" position="after">
            <span
            t-out="website_sale_order.total_credits"
            style="white-space: nowrap;"
        />
        </xpath>
        <xpath expr="//td[@name='website_sale_cart_summary_line_price']//t" position="replace">
            <!-- <attribute name="class">d-none</attribute> -->
        </xpath>
    </template>
    <template id="website_sale_loyalty_inherit" inherit_id="website_sale_loyalty.modify_code_form">
        <xpath expr="//strong[@t-out='points']" position="after">
            <strong class="small" t-out="website_sale_order._get_total_credit_points(coupon)"/>
        </xpath>
        <xpath expr="//strong[@t-out='points']" position="attributes">
            <attribute name="class">d-none</attribute>
        </xpath>
        
    </template>

    <template id="loyalty_buttons" inherit_id="loyalty.loyalty_buttons">
        <xpath expr="//div//p[@id='card_points']" position="after">
            <p id="card_points" class="m-0 text-600">
                <t t-out="card.available_credits"/>
            </p>
        </xpath>
        <xpath expr="//div//p[@id='card_points']" position="attributes">
            <attribute name="class">d-none</attribute>
        </xpath>
    </template>
     <template id="auto_apply_ewallet_inherit" inherit_id="website_sale_loyalty.modify_code_form">
        <xpath expr="//button[@name='o_loyalty_claim']" position="after">
            <script type="text/javascript">
                // Apply eWallet when products are added to cart
                function autoApplyEWallet() {
                const useBtn = document.querySelector("button[name='o_loyalty_claim']");
                const isEwalletApplied = document.querySelector('[data-reward-id]');

                if (useBtn &amp;&amp; !isEwalletApplied) {
                console.log('Auto-applying eWallet...');
                useBtn.click();
                return true;
                }
                return false;
                }

                autoApplyEWallet();

                document.addEventListener('DOMContentLoaded', function() {
                const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                if (mutation.type === 'childList') {
                setTimeout(autoApplyEWallet, 100);
                }
                });
                });

                // Watch for changes in the cart summary
                const cartSummary = document.querySelector('.oe_cart');
                if (cartSummary) {
                observer.observe(cartSummary, { childList: true, subtree: true });
                }
                });
            </script>
        </xpath>
    </template>

</odoo>
