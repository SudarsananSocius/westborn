<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Hide total amounts and add  credits - ONLY FOR BENEFICIARY USERS -->
    <template id="inherit_sale_order_portal_content" inherit_id="sale.sale_order_portal_content">
        <xpath expr="//div[@id='total']" position="attributes">
            <attribute name="groups">!westborn.group_beneficiary_user</attribute>
        </xpath>
        <xpath expr="//div[@id='total']" position="after">
            <div id="credits_total" class="d-flex justify-content-end mt-3">
                <table class="table table-sm w-auto">
                    <tr>
                        <td class="text-end">
                            <strong>Total Credits:</strong>
                        </td>
                        <td class="text-end fw-bold">
                            <span t-esc="sale_order.total_credits or 0"/>
                            Credits
                        </td>
                    </tr>
                </table>
            </div>
        </xpath>

        <!-- Hide Price AND VALUE IN THE TABLE -->
        <xpath expr="//th[@id='product_unit_price_header']" position="attributes">
            <attribute name="groups">!westborn.group_beneficiary_user</attribute>
        </xpath>
        <xpath expr="//th[@id='taxes_header']" position="attributes">
            <attribute name="groups">!westborn.group_beneficiary_user</attribute>
        </xpath>
        <xpath expr="//th[@id='subtotal_header']" position="attributes">
            <attribute name="groups">!westborn.group_beneficiary_user</attribute>
        </xpath>
<!--        values-->
        <xpath expr="//tbody[@class='sale_tbody']//tr[@name='tr_product']/td[@name='td_product_priceunit']"
               position="attributes">
            <attribute name="groups">!westborn.group_beneficiary_user</attribute>
        </xpath>
        <xpath expr="//tbody[@class='sale_tbody']//tr[@name='tr_product']/td[@name='td_product_taxes']"
               position="attributes">
            <attribute name="groups">!westborn.group_beneficiary_user</attribute>
        </xpath>
        <xpath expr="//tbody[@class='sale_tbody']//tr[@name='tr_product']/td[@name='td_product_subtotal']"
               position="attributes">
            <attribute name="groups">!westborn.group_beneficiary_user</attribute>
        </xpath>

        <!--        ADDED CREDITS IN THE TABLE AND Add Credits values in each row -->
        <xpath expr="//th[@id='subtotal_header']" position="after">
            <th class="text-end">Credits</th>
        </xpath>
        <xpath expr="//tbody[@class='sale_tbody']//tr[@name='tr_product']/td[@name='td_product_subtotal']"
               position="after">
            <td class="text-end" name="td_product_credits">
                <span t-out="line.credit_points or 0"/>
            </td>
        </xpath>
    </template>

    <!-- -                                    ORDER LIST - -->
    <template id="inherit_sale_portal_my_orders" inherit_id="sale.portal_my_orders">

        <xpath expr="//th[contains(@class, 'text-end') and contains(., 'Total')]" position="attributes">
            <attribute name="groups">!westborn.group_beneficiary_user</attribute>
        </xpath>
        <xpath expr="//td[contains(@class, 'text-end') and .//span[@t-field='order.amount_total']]"
               position="attributes">
            <attribute name="groups">!westborn.group_beneficiary_user</attribute>
        </xpath>
        <xpath expr="//th[contains(@class, 'text-end') and contains(., 'Total')]" position="after">
            <th class="text-end">
                <span>Total Credits</span>
            </th>
        </xpath>
        <xpath expr="//td[contains(@class, 'text-end') and .//span[@t-field='order.amount_total']]" position="after">
            <td class="text-end">
                <span t-esc="order.total_credits or 0"/>Credits
            </td>
        </xpath>
    </template>

    <!--                                        Sidebar  -->
    <template id="inherit_sale_order_portal_sidebar" inherit_id="sale.sale_order_portal_template">
        <xpath expr="//h2[.//@t-field='sale_order.amount_total']" position="attributes">
            <attribute name="groups">!westborn.group_beneficiary_user</attribute>
        </xpath>
        <xpath expr="//h2[.//@t-field='sale_order.amount_total']" position="after">
            <h2 class="mb-0 text-break">
                <br/>
                <small>
                    <span t-esc="sale_order.total_credits or 0"/>
                    Credits
                </small>
            </h2>
        </xpath>
    </template>

    <!-- ============================== -->
    <!--      INVOICE ORDER PORTAL      -->
    <!-- ============================== -->

<!--                                 Invoice list - -->
    <template id="inherit_account_portal_my_invoices" inherit_id="account.portal_my_invoices">
        <xpath expr="//th[@name='amount_due']" position="attributes">
            <attribute name="groups">!westborn.group_beneficiary_user</attribute>
        </xpath>
        <xpath expr="//td[@name='invoice_amount']" position="attributes">
            <attribute name="groups">!westborn.group_beneficiary_user</attribute>
        </xpath>
        <xpath expr="//th[@name='amount_due']" position="after">
            <th class="text-end">
                <span>Total Credits</span>
            </th>
        </xpath>
        <xpath expr="//td[@name='invoice_amount']" position="after">
            <td class="text-end">
                <span t-esc="invoice.total_credits or 0"/>
                Credits
            </td>
        </xpath>
    </template>

    <!--               Invoice page -Sidebar -->
    <template id="portal_invoice_page_custom"
              name="Portal Invoice Page Custom"
              inherit_id="account.portal_invoice_page">
        <xpath expr="//h2[@class='mb-0 text-break mx-auto']/span" position="attributes">
            <attribute name="groups">!westborn.group_beneficiary_user</attribute>
        </xpath>
        <xpath expr="//h2[@class='mb-0 text-break mx-auto']/span" position="after">
            <br/>
            <small>
                <span t-esc="invoice.total_credits or 0"/> Credits
            </small>
        </xpath>
    </template>


    <!-- Invoice TABLE  -->
    <template id="inherit_report_invoice_document" inherit_id="account.report_invoice_document">
        <!-- Add credits column for ALL users -->
        <xpath expr="//tbody[@class='invoice_tbody']//td[@name='td_subtotal']"
               position="attributes">
            <attribute name="groups">!westborn.group_beneficiary_user</attribute>
        </xpath>
        <xpath expr="//th[@name='th_subtotal']"
               position="attributes">
            <attribute name="groups">!westborn.group_beneficiary_user</attribute>
        </xpath>
        <xpath expr="//table[@name='invoice_line_table']/thead/tr/th[contains(., 'Amount')]" position="after">
            <th class="text-end">
                <span>Credits</span>
            </th>
        </xpath>
        <xpath expr="//td[contains(@class, 'o_price_total')]" position="after">
            <td class="text-end">
                <span t-esc="line.credit_points or 0"/>
                Credits
            </td>
        </xpath>

        <!-- Hide TOTAL AMOUNT -->
        <xpath expr="//div[@id='total']//table" position="after">
            <table class="table table-sm" style="page-break-inside: avoid; width:100%">
                <tbody>
                    <tr class="o_total">
                        <td>
                            <strong>Total Credits:</strong>
                        </td>
                        <td class="text-end">
                            <span t-esc="line.credit_points or 0"/>
                            Credits
                        </td>
                    </tr>
                </tbody>
            </table>
        </xpath>
<xpath expr="//table[contains(@class,'o_total_table')]//t[@t-call='account.document_tax_totals']"
       position="attributes">
    <attribute name="groups">!westborn.group_beneficiary_user</attribute>
</xpath>
<xpath expr="//table[contains(@class,'o_total_table')]//tr[td/i[contains(@class,'oe_payment_label')]]"
       position="attributes">
    <attribute name="groups">!westborn.group_beneficiary_user</attribute>
</xpath>
<xpath expr="//table[contains(@class,'o_total_table')]//tr[@class='fw-bold']"
       position="attributes">
    <attribute name="groups">!westborn.group_beneficiary_user</attribute>
</xpath>

    </template>

</odoo>